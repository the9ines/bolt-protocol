name: Conformance Guard

on:
  pull_request:
    branches: [main]
    paths:
      - "PROTOCOL.md"
      - "LOCALBOLT_PROFILE.md"
      - "docs/CONFORMANCE.md"

jobs:
  conformance-check:
    name: Conformance discipline and coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check conformance discipline (CONFORMANCE-1R)
        run: |
          # Get files changed in this PR relative to the merge base
          MERGE_BASE=$(git merge-base origin/main HEAD)
          CHANGED_FILES=$(git diff --name-only "$MERGE_BASE" HEAD)

          SPEC_CHANGED=false
          CONFORMANCE_CHANGED=false

          for file in $CHANGED_FILES; do
            case "$file" in
              PROTOCOL.md|LOCALBOLT_PROFILE.md)
                SPEC_CHANGED=true
                echo "Spec file changed: $file"
                ;;
              docs/CONFORMANCE.md)
                CONFORMANCE_CHANGED=true
                echo "Conformance matrix updated: $file"
                ;;
            esac
          done

          if [ "$SPEC_CHANGED" = true ] && [ "$CONFORMANCE_CHANGED" = false ]; then
            echo ""
            echo "::error::Spec changed without updating docs/CONFORMANCE.md (CONFORMANCE-1R)."
            echo ""
            echo "Any change to PROTOCOL.md or LOCALBOLT_PROFILE.md must include"
            echo "a corresponding update to docs/CONFORMANCE.md."
            exit 1
          fi

          echo "CONFORMANCE-1R discipline check passed."

      - name: Validate conformance coverage (CONFORMANCE-2R)
        run: |
          FILE="docs/CONFORMANCE.md"

          if [ ! -f "$FILE" ]; then
            echo "::error::docs/CONFORMANCE.md not found."
            exit 1
          fi

          # Count PROTOCOL rows meeting coverage:
          # - Data rows start with "| ยง" or "| Appendix"
          # - Status (awk field 6) is not TODO and not NOT APPLICABLE
          # - Evidence (awk field 7) contains at least one backtick-wrapped path
          PROTO_COVERED=$(awk '/^## PROTOCOL\.md Conformance/,/^---/' "$FILE" | \
            grep -E '^\| ยง|^\| Appendix' | \
            awk -F '|' '{
              status = $6; evidence = $7
              gsub(/^[ \t]+|[ \t]+$/, "", status)
              if (status != "TODO" && status != "NOT APPLICABLE" && evidence ~ /`/) print
            }' | wc -l | tr -d ' ')

          # Count PROFILE rows meeting coverage:
          # - Data rows start with "| ยง"
          PROFILE_COVERED=$(awk '/^## LOCALBOLT_PROFILE\.md Conformance/,/^---/' "$FILE" | \
            grep -E '^\| ยง' | \
            awk -F '|' '{
              status = $6; evidence = $7
              gsub(/^[ \t]+|[ \t]+$/, "", status)
              if (status != "TODO" && status != "NOT APPLICABLE" && evidence ~ /`/) print
            }' | wc -l | tr -d ' ')

          echo "Protocol rows with evidence: $PROTO_COVERED (minimum: 10)"
          echo "Profile rows with evidence: $PROFILE_COVERED (minimum: 5)"

          FAILED=false

          if [ "$PROTO_COVERED" -lt 10 ]; then
            FAILED=true
          fi

          if [ "$PROFILE_COVERED" -lt 5 ]; then
            FAILED=true
          fi

          if [ "$FAILED" = true ]; then
            echo ""
            echo "::error::CONFORMANCE-2R coverage requirement not met."
            echo "Protocol rows with evidence: $PROTO_COVERED (minimum 10 required)"
            echo "Profile rows with evidence: $PROFILE_COVERED (minimum 5 required)"
            exit 1
          fi

          echo "CONFORMANCE-2R coverage check passed."
